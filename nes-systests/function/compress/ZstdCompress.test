# name: compress/ZstdCompress.test
# description: Test compression and decompression
# groups: [Compress]

CREATE LOGICAL SOURCE stream(i8 INT8, i16 INT16, i32 INT32, i64 INT64, u8 UINT8, u16 UINT16, u32 UINT32, u64 UINT64, f32 FLOAT32, f64 FLOAT64, varsized VARSIZED);
CREATE PHYSICAL SOURCE FOR stream TYPE File;
ATTACH INLINE
-42,-129,-32769,-2147483649,42,256,65536,4294967296,23.0,23.0,text123Text!!!
-42,-129,-32769,-2147483649,42,256,65536,4294967296,23.0,23.0,moreText987654321moreText!!!

CREATE LOGICAL SOURCE floatstream(data FLOAT64);
CREATE PHYSICAL SOURCE FOR floatstream TYPE File;
ATTACH INLINE
32.8
32234.04

CREATE LOGICAL SOURCE intstream(data UINT64);
CREATE PHYSICAL SOURCE FOR intstream TYPE File;
ATTACH INLINE
58
2342

CREATE LOGICAL SOURCE varsizedstream(data VARSIZED);
CREATE PHYSICAL SOURCE FOR varsizedstream TYPE File;
ATTACH INLINE
abcdef
xyz

CREATE SINK sinkF64(f64_i8 FLOAT64, f64_i8_plus_1 FLOAT64, f64_i16 FLOAT64, f64_i16_plus_1 FLOAT64, f64_i32 FLOAT64, f64_i32_plus_1 FLOAT64, f64_i64 FLOAT64, f64_i64_plus_1 FLOAT64, f64_u8 FLOAT64, f64_u8_plus_1 FLOAT64, f64_u16 FLOAT64, f64_u16_plus_1 FLOAT64, f64_u32 FLOAT64, f64_u32_plus_1 FLOAT64, f64_u64 FLOAT64, f64_u64_plus_1 FLOAT64, f64_f32 FLOAT64, f64_f32_plus_1 FLOAT64, f64_f64 FLOAT64, f64_f64_plus_1 FLOAT64, varsized VARSIZED) TYPE File;
CREATE SINK sinkFloat(data FLOAT64) TYPE File;
CREATE SINK sinkInt(data UINT64) TYPE File;
CREATE SINK sinkVarsized(data VARSIZED) TYPE File;

# Div f64 value with all other data types
SELECT
    # signed
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / i8)) AS f64_i8,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (i8 + INT8(1)))) AS f64_i8_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / i16)) AS f64_i16,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (i16 + INT16(1)))) AS f64_i16_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / i32)) AS f64_i32,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (i32 + INT32(1)))) AS f64_i32_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / i64)) AS f64_i64,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (i64 + INT64(1)))) AS f64_i64_plus_1,
    # unsigned
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / u8)) AS f64_u8,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (u8 + UINT8(1)))) AS f64_u8_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / u16)) AS f64_u16,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (u16 + UINT16(1)))) AS f64_u16_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / u32)) AS f64_u32,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (u32 + UINT32(1)))) AS f64_u32_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / u64)) AS f64_u64,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (u64 + UINT64(1)))) AS f64_u64_plus_1,
    # float
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / f32)) AS f64_f32,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (f32 + FLOAT32(1)))) AS f64_f32_plus_1,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / f64)) AS f64_f64,
    ZstdDecompress(ZstdCompress(ZstdDecompress(ZstdCompress(f64)) / (f64 + FLOAT64(1)))) AS f64_f64_plus_1,
    ZstdDecompress(ZstdCompress(varsized)) AS varsized
FROM stream INTO sinkF64;
----
-0.547619,-0.560976,-0.178295,-0.179688,-0.000702,-0.000702,-0.000000,-0.000000,0.547619,0.534884,0.089844,0.089494,0.000351,0.000351,0.000000,0.000000,1.000000,0.958333,1.000000,0.958333,text123Text!!!
-0.547619,-0.560976,-0.178295,-0.179688,-0.000702,-0.000702,-0.000000,-0.000000,0.547619,0.534884,0.089844,0.089494,0.000351,0.000351,0.000000,0.000000,1.000000,0.958333,1.000000,0.958333,moreText987654321moreText!!!

SELECT ZstdDecompress(ZstdCompress(data)) AS data FROM floatstream INTO sinkFloat;
----
32.8
32234.04

SELECT ZstdDecompress(ZstdCompress(data)) AS data FROM intstream INTO sinkInt;
----
58
2342

SELECT ZstdDecompress(ZstdCompress(data)) AS data FROM varsizedstream INTO sinkVarsized;
----
abcdef
xyz
